# Сборка образа Docker для платформы Megamind
на примере программы расчета цифр числа Пи (calcpi)

#### Предварительные условия 
1. Ubuntu 18.04 или другая ОС/дистрибутив с поддержкой Docker
2. Каталог с программой calcpi

#### Ожидаемый результат
Пользовательское приложение (в этом примере - calcpi), обернутое в контейнер docker и готовое к запуску на мощностях платформы **Megamind**. Доступ к контейнеру по SSH. Образ приложения размещен в репозитории **Megamind**.

#### Установка и настройка Docker
Установим docker. Для этого выполним следующие команды в терминале:

```
sudo apt update
sudo apt install docker.io
```
Подключим его к репозиторию образов Megamind:

```
sudo docker login https://megamind.network/v2/
```
Появится запрос на ввод логина и пароля, нужно ввести логин и пароль в системе **Megamind**.

#### Создание Dockerfile
Опишем создаваемый образ в терминах ```Dockerfile```. Для этого выполним команды:

```
mkdir ~/docker-calcpi
cd ~/docker-calcpi/
nano Dockerfile
```

Будет открыт текстовый редактор ```nano``` с пустым документом. Если редактор не открывается, возможно, его нужно установить командой ```sudo apt install nano```.

Опишем образ в виде ```Dockerfile```. Для этого введем и сохраним в ```nano``` следующий текст:

```
# базовый образ для создаваемого образа
FROM nvidia/cuda:10.1-base

# установка sshd
RUN apt-get update && apt-get install -y openssh-server
RUN mkdir /var/run/sshd

# выставление логина и пароля для ssh
RUN echo 'root:mypassword' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#Port 22/Port 17888/' /etc/ssh/sshd_config

# фикс для входа по SSH. предотвращает разлогин сразу после входа
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile

# добавление стартового скрипта в образ
ADD start.sh /

# добавление папки с программой calcpi в образ
ADD calcpi /calcpi

# открытие порта 17888 наружу
EXPOSE 17888

# точка входа в образ, то, что запускается первым и единственным
ENTRYPOINT ["/start.sh"]
```
Как можно видеть выше, этот ```Dockerfile``` описывает контейнер на базе контейнера Nvidia CUDA 10.1, в который добавлен сервер SSH с необходимыми настройками, открыт наружу порт 17888 для SSH и добавлено приложение calcpi.

#### Создание стартового скрипта
Docker не поддерживает запуск нескольких сущностей из одного образа, поэтому для запуска и SSH, и пользовательского приложения необходим стартовый скрипт. Создадим его, вызвав ```nano start.sh```. В простейшем случае стартовый скрипт должен содержать следующий текст:

```
#!bin/bash
/usr/sbin/sshd -D &
/calcpi/nctest
```
Первая строка задает формат файла для командного интерпретатора, ```/usr/sbin/sshd -D &``` запускает SSH-сервер, ```/calcpi/nctest``` запускает собственно пользовательское приложение, в данном случае - исполняемый файл программы расчета цифр числа Пи ```calcpi```.

При постановке задачи через **Megamind API** в запускаемый образ можно передать строку с произвольными данными. Чтобы получить ее внутри образа, нужно использовать первый аргумент запускаемого скрипта, ```$1```. В данном примере передача параметров в образ не требуется, но для демонстрации концепции просто выведем полученный данные в ```stdout```. Для этого файл изменим на такой:
```
#!bin/bash
/usr/sbin/sshd -D &
echo $1
/calcpi/nctest
```

Строка ```echo $1``` выводит переданные параметры в ```stdout```. Например, если при постановке задачи в **Megamind API** в качестве параметров к образу была использована строка ```"hello world!"```, то параметр ```$1``` будет содержать именно эту строку. Таким образом, передачу параметров в пользовательское приложение можно организовать с помощью вызова с параметром ```$1```, например, вместо строки ```/calcpi/nctest``` будет строка ```/mydir/mycoolapp $1```, а содержимым строки может быть JSON или XML.

Скрипт должен иметь права на запуск. Выставить их можно командой ```chmod +x start.sh```.

#### Создание образа
Скопируем любым удобным образом директорию с приложением ```calcpi``` в текущую директорию. Убедимся, что указанный в скрипте файл имеет права на исполнение:
```
chmod +x calcpi/nctest
```
Соберем образ командой 
```
sudo docker build .
```

#### Выгрузка образа в репозиторий
После успешной сборки образа пометим (```tag```) его. Для этого выведем список образов на локальной машине и выберем из них последний по времени создания:
```
sudo docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
<none>              <none>              e750d6b55691        7 seconds ago       322MB
nvidia/cuda         10.1-base           ad406665a7f7        4 days ago          106MB
```
Очевидно, что последний образ - образ имеет идентификатор ```IMAGE ID``` e750d6b55691. Пометим его:
```
sudo docker tag e750d6b55691 megamind.network/calcpi:mytest
```
Эта команда присваивает образу с идентификатором ```e750d6b55691``` метку ```megamind.network/calcpi:mytest```, в которой ```megamind.network/``` - обязательная часть, ```calcpi``` - имя образа (выбирается произвольно), ```mytest``` - метка версии (выбирается произвольно, один образ может содержать несколько версий).
Выгрузим образ в репозиторий **Megamind**:
```
sudo docker push megamind.network/calcpi:mytest
```
С этого момента образ ```megamind.network/calcpi:mytest``` доступен для запуска на платформе **Megamind**. Для запуска и контроля задач нужно использовать [Megamind API](./api-readme.md).